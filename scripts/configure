#!/bin/bash

set -e

SCRIPT_DIR=$(cd -- "$(dirname -- "${BASH_SOURCE:-$0}")" &> /dev/null && pwd)

# Add emscripten toolchain
export EMSDK_QUIET=1
source "$SCRIPT_DIR/../emsdk/emsdk_env.sh"
cd "$SCRIPT_DIR/../libreoffice-core"

# LOK requires GCC 12, which often isn't the default, check for gcc-12 and g++12 if necessary
BUILD_CC=
BUILD_CXX=
GCC_VERSION=$(gcc --version | head -n1 | grep -oP '\d+\.\d+\.\d+' | tail -n1 | grep -oP '\d+' | head -n1)
if [[ $GCC_VERSION -lt 12 ]]; then
  if which gcc-12 &>/dev/null && which g++-12 &>/dev/null; then
    BUILD_CC='CC_FOR_BUILD=gcc-12'
    BUILD_CXX='CXX_FOR_BUILD=g++-12'
  fi
fi

BUILD_TYPE=
if [[ "$1" == "dev" ]]; then
  echo "Configuring dev build"
  echo
  BUILD_TYPE=--enable-optimized=debug
fi
if [[ "$1" == "debug" ]]; then
  echo "Configuring debug build"
  echo
  BUILD_TYPE=--enable-optimized=no
fi

./autogen.sh --with-distro=CPWASM-LOKit $BUILD_CC $BUILD_CXX $BUILD_TYPE
